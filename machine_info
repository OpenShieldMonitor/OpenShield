import json
import subprocess
import platform
import sys

# 1. Funciones

# Función para poder ejecutar comandos en el sistema
def ejecutar_comando(comando):
    resultado = subprocess.run(comando, shell=True, capture_output=True, text=True)
    if resultado.returncode == 0:
        return resultado.stdout.strip()
    else:
        return f"ERROR: {resultado.stderr.strip()}"

# Funcion para poder exportar a JSON
def exportar_a_json(datos, archivo):
    print(f"Exportando datos a '{archivo}'...")
    with open(archivo, "w") as f:
        json.dump(datos, f, indent=4)
    print("Exportación completada.\n")

# Función para obtener nombre y versión del sistema operativo
def obtener_os():
    print("Obteniendo información del sistema operativo...")
    so = platform.system()
    version = platform.release()
    print(f"Sistema operativo detectado: {so} {version}\n")
    return so, {
        "Product_Name": so,
        "Product_Version": version
    }

#2.Recogida de datos de la máquina objetivo

# Listar paquetes instalados dependiendo del sistema operativo detectado
def listar_paquetes_instalados(so):
    print("Listando paquetes instalados...")
    paquetes = []

    if so == "Linux":
        salida = ejecutar_comando("apt list --installed 2>/dev/null | tail -n +2")
        for linea in salida.split('\n'):
            if not linea.strip():
                continue
            partes = linea.split('/')
            if len(partes) < 2:
                continue
            nombre = partes[0].strip()
            resto = partes[1].strip().split()
            version = resto[1] if len(resto) >= 2 else "N/A"
            paquetes.append({"Product_Name": nombre, "Product_Version": version})

    elif so == "Darwin":  # macOS
        salida = ejecutar_comando("brew list --versions")
        for linea in salida.split('\n'):
            if not linea.strip():
                continue
            partes = linea.strip().split()
            if len(partes) >= 2:
                nombre = partes[0]
                version = partes[1]
                paquetes.append({"Product_Name": nombre, "Product_Version": version})

    elif so == "Windows":
        salida = ejecutar_comando('powershell "Get-WmiObject -Class Win32_Product | Select-Object Name, Version"')
        for linea in salida.split('\n'):
            if not linea.strip() or 'Name' in linea or '---' in linea:
                continue
            partes = linea.strip().rsplit(None, 1)
            if len(partes) == 2:
                nombre, version = partes
                paquetes.append({"Product_Name": nombre, "Product_Version": version})

    else:
        print(" Sistema operativo no reconocido para listar paquetes.")

    print(f"{len(paquetes)} paquetes detectados.\n")
    return paquetes

# 3.Export de la información
print("Iniciando exportacion de datos...\n")

so_nombre, so_info = obtener_os()

datos_unificados = {
    "OS": so_info,
    "Installed_Packages": listar_paquetes_instalados(so_nombre)
}

exportar_a_json(datos_unificados, "machine_info.json")

print("Recogida de datos completada. Archivo generado: machine_info.json\n")
